parameters:
  - name: coverageDir
    type: string
    default: build/reports

steps:
  - template: install-go.yaml
  - script: |
      go install github.com/jstemmer/go-junit-report@latest
      go install github.com/axw/gocov/gocov@latest
      go install github.com/AlekSi/gocov-xml@latest
    displayName: 'Install Testing Dependencies'
  - script: |
      REPORT_DIR=${{ parameters.coverageDir }}
      mkdir -p "${REPORT_DIR}"
      export MGW_HOME=${PWD}/resources

      make test 2>&1 | tee "${REPORT_DIR}"/test.out
      testExitCode="${PIPESTATUS[0]}"
      if [ ${testExitCode} -ne 0 ]; then
        exit ${testExitCode}
      fi

      GOBIN=$(go env GOPATH)/bin
      cat "${REPORT_DIR}"/test.out | ${GOBIN}/go-junit-report > "${REPORT_DIR}"/report.xml
      ${GOBIN}/gocov convert coverage.txt > "${REPORT_DIR}"/coverage.json
      ${GOBIN}/gocov-xml < "${REPORT_DIR}"/coverage.json > "${REPORT_DIR}"/coverage.xml
    displayName: 'Run Unit Tests'
    workingDirectory: 'global-adapter'
  - task: PublishTestResults@2
    inputs:
      testRunner: JUnit
      testResultsFiles: $(System.DefaultWorkingDirectory)/global-adapter/${{ parameters.coverageDir }}/report.xml
  - task: PublishCodeCoverageResults@1
    condition: always()
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: $(System.DefaultWorkingDirectory)/global-adapter/${{ parameters.coverageDir }}/coverage.xml
