parameters:
  - name: coverageDir
    type: string
    default: target

steps:
  - script: |
      cd global-adapter
      REPORT_DIR=${{ parameters.coverageDir }}
      mkdir -p "${REPORT_DIR}"
      export MGW_HOME=${PWD}/resources
      go clean -testcache

      go test -race -coverprofile=./${REPORT_DIR}/coverage.txt -covermode=atomic ./...
      go tool cover -html=./${REPORT_DIR}/coverage.txt | tee "${REPORT_DIR}"/test.out
      testExitCode="${PIPESTATUS[0]}"
      if [ ${testExitCode} -ne 0 ]; then
        exit ${testExitCode}
      fi

      GOBIN=$(go env GOPATH)/bin
      cat "${REPORT_DIR}"/test.out | ${GOBIN}/go-junit-report > "${REPORT_DIR}"/report.xml
      ${GOBIN}/gocov convert coverage.txt > "${REPORT_DIR}"/coverage.json
      ${GOBIN}/gocov-xml < "${REPORT_DIR}"/coverage.json > "${REPORT_DIR}"/coverage.xml
    displayName: 'Run Unit Tests'
  - task: PublishTestResults@2
    inputs:
      testRunner: JUnit
      testResultsFiles: $(System.DefaultWorkingDirectory)/${{ parameters.coverageDir }}/report.xml
  - task: PublishCodeCoverageResults@1
    inputs:
      codeCoverageTool: Cobertura
      summaryFileLocation: $(System.DefaultWorkingDirectory)/${{ parameters.coverageDir }}/coverage.xml
